import{a as w}from"./chunk-2EKWLGMH.js";import{c as E,d as p,e as y,f as S,g as P,h as I,i as k,k as T,l as N}from"./chunk-SNNRYO6Z.js";import"./chunk-RPALSS5Z.js";import{$a as o,E as _,Ka as C,Oa as m,Tb as x,U as f,Wb as v,Za as s,_a as r,ab as d,hb as g,jb as c,qb as i,rb as h,sb as b,za as l}from"./chunk-A5EMK4AJ.js";function M(t,a){t&1&&(r(0,"small",10),i(1," El nombre es obligatorio. "),o())}function A(t,a){t&1&&(r(0,"small",10),i(1," El email es obligatorio. "),o())}function F(t,a){t&1&&(r(0,"small",10),i(1," Ingresa un email v\xE1lido. "),o())}function V(t,a){t&1&&(r(0,"small",10),i(1," La contrase\xF1a actual es obligatoria. "),o())}function q(t,a){t&1&&(r(0,"small",10),i(1," Contrase\xF1a actual incorrecta. "),o())}function D(t,a){t&1&&(r(0,"small",10),i(1," La nueva contrase\xF1a es obligatoria. "),o())}function z(t,a){if(t&1&&(r(0,"small",10),i(1),o()),t&2){let n,e=c();l(),b(" Debe tener al menos ",(n=e.password.controls.next.getError("minlength"))==null?null:n.requiredLength," caracteres. ")}}function L(t,a){t&1&&(r(0,"small",10),i(1," La nueva contrase\xF1a no puede ser igual a la actual. "),o())}function G(t,a){if(t&1&&(r(0,"p",11),i(1),o()),t&2){let n=c();l(),h(n.errPass)}}function B(t,a){if(t&1&&(r(0,"p",12),i(1),o()),t&2){let n=c();l(),h(n.okPass)}}function R(t,a){return n=>{let e=n.get(t)?.value??"",u=n.get(a)?.value??"";return e&&u&&e===u?{samePassword:!0}:null}}var O=class t{fb=f(T);auth=f(w);busy=!1;errPass="";okPass="";profile=this.fb.nonNullable.group({name:["",p.required],email:["",[p.required,p.email]]});password=this.fb.nonNullable.group({old:["",[p.required]],next:["",[p.required,p.minLength(8)]]},{validators:[R("old","next")]});getUserBasics(){let a=this.auth.user?.(),n=a?.username??localStorage.getItem("auth_email")??"";return{name:a?.name??localStorage.getItem("auth_name")??(n.split("@")[0]||""),email:n}}ngOnInit(){let{name:a,email:n}=this.getUserBasics();this.profile.patchValue({name:a,email:n}),window.addEventListener("storage",this._onStorage)}ngOnDestroy(){window.removeEventListener("storage",this._onStorage)}_onStorage=a=>{if(a.key==="auth_name"||a.key==="auth_email"){let{name:n,email:e}=this.getUserBasics();this.profile.patchValue({name:n,email:e},{emitEvent:!1})}};saveProfile(){if(this.profile.invalid){this.profile.markAllAsTouched();return}this.busy=!0;let{name:a,email:n}=this.profile.getRawValue();localStorage.setItem("auth_name",a),localStorage.setItem("auth_email",n),this.busy=!1,this.okPass="Perfil actualizado.",setTimeout(()=>this.okPass="",2500)}savePassword(){if(this.password.invalid){this.password.markAllAsTouched();return}this.errPass="",this.okPass="",this.busy=!0;let{old:a,next:n}=this.password.getRawValue();this.auth.changePassword(a,n).pipe(_(()=>this.busy=!1)).subscribe({next:()=>{this.okPass="Contrase\xF1a actualizada.",this.password.reset(),setTimeout(()=>this.okPass="",2500)},error:e=>{if(e?.status===400||e?.status===401){this.password.controls.old.setErrors({invalidCurrent:!0}),this.password.controls.old.markAsTouched();return}this.errPass=e?.error?.message??"No se pudo actualizar la contrase\xF1a."}})}static \u0275fac=function(n){return new(n||t)};static \u0275cmp=C({type:t,selectors:[["app-cuenta"]],decls:35,vars:15,consts:[[1,"wrap"],[1,"card",3,"ngSubmit","formGroup"],["type","text","formControlName","name"],["class","err",4,"ngIf"],["type","email","formControlName","email"],["type","submit",1,"btn","btn-primary",3,"disabled"],["type","password","formControlName","old","autocomplete","current-password"],["type","password","formControlName","next","autocomplete","new-password"],["class","form-error",4,"ngIf"],["class","form-ok",4,"ngIf"],[1,"err"],[1,"form-error"],[1,"form-ok"]],template:function(n,e){n&1&&(r(0,"section",0)(1,"h1"),i(2,"Mi cuenta"),o(),r(3,"form",1),g("ngSubmit",function(){return e.saveProfile()}),r(4,"h2"),i(5,"Perfil"),o(),r(6,"label"),i(7," Nombre "),d(8,"input",2),m(9,M,2,0,"small",3),o(),r(10,"label"),i(11," Email "),d(12,"input",4),m(13,A,2,0,"small",3)(14,F,2,0,"small",3),o(),r(15,"button",5),i(16,"Guardar"),o()(),r(17,"form",1),g("ngSubmit",function(){return e.savePassword()}),r(18,"h2"),i(19,"Contrase\xF1a"),o(),r(20,"label"),i(21," Actual "),d(22,"input",6),m(23,V,2,0,"small",3)(24,q,2,0,"small",3),o(),r(25,"label"),i(26," Nueva "),d(27,"input",7),m(28,D,2,0,"small",3)(29,z,2,1,"small",3),o(),m(30,L,2,0,"small",3),r(31,"button",5),i(32),o(),m(33,G,2,1,"p",8)(34,B,2,1,"p",9),o()()),n&2&&(l(3),s("formGroup",e.profile),l(6),s("ngIf",e.profile.controls.name.touched&&e.profile.controls.name.hasError("required")),l(4),s("ngIf",e.profile.controls.email.touched&&e.profile.controls.email.hasError("required")),l(),s("ngIf",e.profile.controls.email.touched&&e.profile.controls.email.hasError("email")),l(),s("disabled",e.profile.invalid||e.busy),l(2),s("formGroup",e.password),l(6),s("ngIf",e.password.controls.old.touched&&e.password.controls.old.hasError("required")),l(),s("ngIf",e.password.controls.old.touched&&e.password.controls.old.hasError("invalidCurrent")),l(4),s("ngIf",e.password.controls.next.touched&&e.password.controls.next.hasError("required")),l(),s("ngIf",e.password.controls.next.touched&&e.password.controls.next.hasError("minlength")),l(),s("ngIf",e.password.touched&&e.password.hasError("samePassword")),l(),s("disabled",e.password.invalid||e.busy),l(),b(" ",e.busy?"Actualizando\u2026":"Actualizar"," "),l(),s("ngIf",e.errPass),l(),s("ngIf",e.okPass))},dependencies:[v,x,N,P,E,y,S,I,k],styles:[".wrap[_ngcontent-%COMP%]{max-width:720px;margin:20px auto;padding:0 16px}.card[_ngcontent-%COMP%]{border:1px solid #e9efec;border-radius:14px;padding:14px;margin:16px 0;display:grid;gap:10px}label[_ngcontent-%COMP%]{display:grid;gap:6px}input[_ngcontent-%COMP%]{height:40px;border:1px solid #d0d5dd;border-radius:10px;padding:0 12px}.btn[_ngcontent-%COMP%]{height:40px;border-radius:999px;padding:0 16px;border:0;background:#0fb366;color:#fff;font-weight:800}.btn[disabled][_ngcontent-%COMP%]{opacity:.6;cursor:not-allowed}.err[_ngcontent-%COMP%]{color:#b42318;font-size:12px}.form-error[_ngcontent-%COMP%]{color:#b42318;background:#fee4e2;border:1px solid #fda29b;padding:8px 10px;border-radius:8px}.form-ok[_ngcontent-%COMP%]{color:#027a48;background:#ecfdf3;border:1px solid #abefc6;padding:8px 10px;border-radius:8px}"]})};export{O as CuentaComponent};
