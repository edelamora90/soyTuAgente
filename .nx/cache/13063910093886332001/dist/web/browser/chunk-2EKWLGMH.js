import{a as k}from"./chunk-RPALSS5Z.js";import{$b as m,M as o,P as h,U as p,ac as T,c as a,ha as f,q as c}from"./chunk-A5EMK4AJ.js";var i=`${k.apiUrl}/auth`,l="accessToken",g="refreshToken",u="user";function b(t){try{return JSON.parse(atob(t.split(".")[1]))}catch{return null}}function n(t){if(!t)return!0;let e=b(t);if(!e?.exp)return!0;let r=Math.floor(Date.now()/1e3);return e.exp<=r}var d=class t{http=p(T);user=f((()=>{let e=localStorage.getItem(u);return e?JSON.parse(e):null})());get accessToken(){return localStorage.getItem(l)}get refreshToken(){return localStorage.getItem(g)}setTokens(e,r){localStorage.setItem(l,e),localStorage.setItem(g,r)}setUser(e){this.user.set(e),localStorage.setItem(u,JSON.stringify(e))}clear(){localStorage.removeItem(l),localStorage.removeItem(g),localStorage.removeItem(u),this.user.set(null)}login(e,r){return this.http.post(`${i}/login`,{username:e,password:r}).pipe(o(s=>{this.setTokens(s.accessToken,s.refreshToken),this.setUser(s.user)}))}refresh(){let e=this.refreshToken??"",r=new m({Authorization:`Bearer ${e}`});return this.http.post(`${i}/refresh`,{},{headers:r}).pipe(o(s=>this.setTokens(s.accessToken,s.refreshToken)))}isLoggedIn(){return!!this.accessToken&&!n(this.accessToken)}ensureValidSession(){return a(this,null,function*(){if(this.accessToken&&!n(this.accessToken))return!0;if(this.refreshToken&&!n(this.refreshToken))try{return yield c(this.refresh()),!0}catch{return this.clear(),!1}return this.clear(),!1})}getValidAccessToken(){return a(this,null,function*(){if(this.accessToken&&!n(this.accessToken))return this.accessToken;if(this.refreshToken&&!n(this.refreshToken))try{return(yield c(this.refresh())).accessToken}catch{return this.clear(),null}return this.clear(),null})}logout(){this.clear()}changePassword(e,r){return this.http.post(`${i}/change-password`,{old:e,next:r})}updateProfile(e){return this.http.post(`${i}/profile`,e).pipe(o(r=>this.setUser(r.user)))}static \u0275fac=function(r){return new(r||t)};static \u0275prov=h({token:t,factory:t.\u0275fac,providedIn:"root"})};export{d as a};
